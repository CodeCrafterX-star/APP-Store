<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App Store</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <h1>App Store</h1>
        <input type="text" id="search" placeholder="Search apps..." onkeyup="renderApps()">
        <select id="category-filter" onchange="renderApps()">
            <option value="">All Categories</option>
            <option value="Games">Games</option>
            <option value="Productivity">Productivity</option>
            <option value="Social">Social</option>
            <option value="Utilities">Utilities</option>
        </select>
        <button id="subscribe-btn">Subscribe to Notifications</button>
    </header>
    <main>
        <div id="app-grid"></div>
        <div id="app-details" class="hidden">
            <button onclick="hideDetails()">Back</button>
            <h2 id="app-name"></h2>
            <img id="app-icon" alt="App Icon">
            <p id="app-description"></p>
            <p>Category: <span id="app-category"></span></p>
            <p>Rating: <span id="app-rating"></span>⭐</p>
            <p>Version: <span id="app-version"></span></p>
            <p>Developer: <span id="app-dev"></span></p>
            <button id="toggle-favorite-btn"></button>
            <a id="app-download" href="#" target="_blank">Download</a>
        </div>
    </main>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>

    <!-- OneSignal SDK -->
    <script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" async></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCvMEcXUmtImXjYOgGwyCJEJuVcoEvb8h4",
            authDomain: "app-1a53a.firebaseapp.com",
            projectId: "app-1a53a",
            storageBucket: "app-1a53a.firebasestorage.app",
            messagingSenderId: "1024256363080",
            appId: "1:1024256363080:web:37b2bb10ae96f67442a67d"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Initialize OneSignal
        window.OneSignal = window.OneSignal || [];
        OneSignal.push(() => {
            OneSignal.init({
                appId: "YOUR_ONESIGNAL_APP_ID", // Replace with your OneSignal App ID
                safari_web_id: "webonesignalid", // Optional, for Safari
                notifyButton: {
                    enable: true // Shows a subscription bell
                }
            });
        });

        // Subscribe to Notifications
        document.getElementById('subscribe-btn').addEventListener('click', () => {
            OneSignal.push(() => {
                OneSignal.showSlidedownPrompt().then(() => {
                    alert('Subscription prompt shown!');
                }).catch(err => console.error('Error showing prompt:', err));
            });
        });

        // App Data
        let apps = [];
        let favorites = JSON.parse(localStorage.getItem('favorites')) || [];

        // Fetch Apps from Firestore
        function fetchApps(callback) {
            db.collection('apps').get()
                .then(querySnapshot => {
                    apps = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    callback();
                })
                .catch(error => console.error('Error fetching apps:', error));
        }

        // Render Apps
        function renderApps() {
            const grid = document.getElementById('app-grid');
            grid.innerHTML = apps
                .filter(app => {
                    const search = document.getElementById('search').value.toLowerCase();
                    const category = document.getElementById('category-filter').value;
                    return app.name.toLowerCase().includes(search) &&
                           (category === '' || app.category === category);
                })
                .sort((a, b) => b.rating - a.rating)
                .map(app => {
                    const safeId = app.id.replace(/'/g, "\\'");
                    return `
                        <div class="app-card ${favorites.includes(app.id) ? 'favorite' : ''}" onclick="selectApp('${safeId}')">
                            <img src="${app.icon}" alt="${app.name}">
                            <h3>${app.name}</h3>
                            <p>${app.description}</p>
                            <p>Category: ${app.category}</p>
                            <p>Rating: ${app.rating}⭐</p>
                    <p>Version: ${app.version}</p>
                    <p>Dev: ${app.dev}</p>
                    <button onclick="toggleFavorite('${safeId}', event)">${favorites.includes(app.id) ? '★' : '☆'}</button>
                    <a href="${app.downloadUrl}" target="_blank">Download</a>
                </div>
            `;
        })
        .join('');
    }

    // Select App for Details
    function selectApp(appId) {
        const app = apps.find(a => a.id === appId);
        document.getElementById('app-name').textContent = app.name;
        document.getElementById('app-icon').src = app.icon;
        document.getElementById('app-description').textContent = app.description;
        document.getElementById('app-category').textContent = app.category;
        document.getElementById('app-rating').textContent = app.rating;
        document.getElementById('app-version').textContent = app.version;
        document.getElementById('app-dev').textContent = app.dev;
        document.getElementById('app-download').href = app.downloadUrl;
        document.getElementById('toggle-favorite-btn').textContent = favorites.includes(appId) ? '★' : '☆';
        document.getElementById('toggle-favorite-btn').onclick = () => toggleFavorite(appId);
        document.getElementById('app-details').classList.remove('hidden');
        document.getElementById('app-grid').classList.add('hidden');
    }

    // Hide Details
    function hideDetails() {
        document.getElementById('app-details').classList.add('hidden');
        document.getElementById('app-grid').classList.remove('hidden');
    }

    // Toggle Favorite
    function toggleFavorite(appId, event) {
        if (event) event.stopPropagation();
        if (favorites.includes(appId)) {
            favorites = favorites.filter(id => id !== appId);
        } else {
            favorites.push(appId);
        }
        localStorage.setItem('favorites', JSON.stringify(favorites));
        renderApps();
        if (document.getElementById('app-details').classList.contains('hidden')) {
            selectApp(appId); // Refresh details if open
        }
    }

    // Initialize
    fetchApps(renderApps);
    </script>
</body>
</html>
